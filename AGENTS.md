# AGENTS.md

> Next.js v16 + Mastra + Amazon Bedrock（ローカル開発）/ Tailwind / bun
> 原則：Mastra のツール・エージェントは **サーバー側のみ**。**ブラウザには一切バンドルしない**（API 越しに呼ぶ）

---

## 1. 目的

- 本プロジェクトの **AI エージェント開発ポリシー**（原則・品質基準・運用プロセス）を明文化し、判断とレビュー基準を統一する。
- Mastra の機能を **安全にローカルで検証** できるページ群（Playground）を段階的に追加できるようにする。
- **Amazon Bedrock** を AI プロバイダとして利用しつつ、将来のモデル差し替えや機能拡張に耐えるアーキテクチャを志向する。
- **TDD / TypeScript strict / zod / Biome / Conventional Commits** を中核に据え、人間開発者主体で継続的に改善できる体制を作る。
- **運用プロセス（GitHub Issues → ブランチ → PR/レビュー → docs 記録 → CI）** を標準化する。

---

## 2. スコープ（ゴール / 非ゴール）

### ゴール
- Next.js（App Router）上で **サーバー専用 Mastra ツール/エージェント** を提供し、UI は API 経由でのみ利用する。
- Bedrock を用いた **チャット / ツール実行 / 軽量評価 /（将来）簡易 RAG** のローカル検証。
- **TypeScript strict** と **zod** によるスキーマバリデーションで型安全を高める。
- **TDD（ユニットテスト先行）** を標準とし、変更に強い設計と回帰のしやすさを担保する。
- **UI ライブラリは shadcn/ui と MUI の併用を許可**。機能ごとに **記述量・可読性・メンテナンス性** を比較し採用する。
- **CI は GitHub Actions** を想定（lint・typecheck・test・セキュリティ検査など）。

### 非ゴール
- 本番クラウド運用の完成（WAF/監査/本番デプロイ/Secrets 運用の確立）。
- ブラウザ内 LLM（WebGPU 等）や外部連携（Slack/Discord ボット等）の詳細設計。
- **具体的なコードやセットアップスクリプト、固定ディレクトリ構成の提示**（変更前提のため本書では記載しない）。

---

## 3. 前提 / 技術選定

- **アプリ**: Next.js v16（App Router）, Tailwind
- **UI ライブラリ**: **shadcn/ui, MUI**（併用可。機能単位で選定方針を記録）
- **AI SDK / Provider**: Amazon Bedrock（モデルやパラメータは環境変数で注入）
- **実行**: Node.js ランタイム（Edge は使用しない）
- **パッケージ管理**: bun
- **型**: TypeScript（strict 有効）
- **スキーマ**: zod（API 入出力・設定値の検証）
- **品質**: Biome（lint/format）
- **テスト**: ユニットテスト中心（TDD）
- **コミット規約**: Conventional Commits
- **CI**: GitHub Actions

---

## 4. 開発プロセス（GitHub 運用）

### 4.1 要件定義（Issue 起票）
- **開発開始前**に、各機能の要件を **GitHub Issue** で定義する。
- Issue には以下を含める：目的／受入基準／影響範囲（UI/API/ツール/ログ/テスト）／非機能（性能・セキュリティ）／検証方法。
- 仕様変更が生じた場合は Issue を更新し、必要に応じて分割・関連付けを行う。

### 4.2 ブランチ戦略と PR
- 作業は **main からブランチ作成**（例：feature/xxx, fix/yyy）。
- **機能ごとに PR** を作成し、**最初の Issue を必ず参照**（例：Closes #123）。
- **マージ前レビュー必須**：
  - ユニットテスト（TDD）の追加・更新。
  - Biome（lint/format）合格。
  - zod による API 入口のバリデーション。
  - server-only 原則の順守。
  - Conventional Commits 準拠のコミットメッセージ。
  - 必要に応じて UI ライブラリ選定理由（shadcn/ui vs MUI）の短評を PR に記録。

### 4.3 ドキュメント（docs/）
- **docs/** に新規機能・設計変更の記録（Decision Records）を残す。
- 何を・なぜ・どの選択肢を比較して採用したかを明確化し、後追いで意図を理解できる状態にする。
- **README.md は人間用**（AI は参照しない運用を明記）。

---

## 5. 原則（セキュリティ / サーバー境界 / プライバシー）

- **Zero-Exposure**：AWS 資格情報・Bedrock クライアント・ツール実装は **サーバー限定**。UI に露出させない。
- **API 境界の厳格化**：UI は API を呼ぶのみ。API 入口で **zod による検証**・サイズ上限・レート制限・構造化ログを適用。
- **ランタイム**：Node.js を前提。署名・依存の都合で Edge は対象外。
- **最小権限**：外部 HTTP / ファイル I/O を行うツールは **許可ドメイン／サンドボックスパス** を明示。
- **ログ**：リクエスト ID・ツール名・所要時間・失敗理由・再試行回数などを構造化して記録（PII は極力扱わない）。

---

## 6. アーキテクチャ指針

- **サーバー中心**：エージェント／ツールはサーバーに閉じ、UI はフォームと表示のみ。
- **疎結合**：UI ⇔ API ⇔ エージェント ⇔ ツールの責務分離。差し替え容易性を重視。
- **設定は注入**：モデル ID／温度／トークン上限などは **環境変数から注入**（固定しない）。
- **UI ライブラリ選定**：shadcn/ui と MUI を併用可。**記述量・学習コスト・アクセシビリティ・デザイン整合性・保守性**を比較し、採用理由を docs/ に記録。
- **将来拡張性**：Mastra 機能を **「1機能=1ページ」**で追加可能。実務的エージェント群は別カテゴリとして増やせる設計を志向。
- **依存の最小化**：標準機能優先。新規依存はコスト／効果／ロックイン影響を記録した上で採用。

---

## 7. 型安全とバリデーション

- **TypeScript strict** を必須化。暗黙 any や曖昧な union を避ける。
- **zod** によるエッジ（API）での **parse** を徹底。
  - 入力の正規化・制限・エラー形状の統一。
  - バリデーション失敗は **明示的エラー**。ログには詳細（個人情報を除く）を構造化出力。

---

## 8. テスト戦略（TDD）

- **ユニットテスト先行**：純粋ロジック（ツール入出力・スキーマ）から着手。
- **API テスト**：バリデーション・ステータスコード・エラー形状・レート制限応答を確認。
- **観点**：決定性／失敗時の挙動／ログ出力の有無／入力サイズ上限／許可範囲チェック／タイムアウト。
- **PR 必須**：新規・変更ロジックに対するテストが追加／更新されていること。

---

## 9. 品質運用（Biome / Conventional Commits / README）

- **Biome** を lint/format の単一基盤とする（プロジェクトで統一）。
- **Conventional Commits**（feat/fix/docs/test/refactor/chore 等）を遵守。
- **README.md は人間向け**：セットアップ・意図・背景を説明。AI は参照しない。

---

## 10. 構成管理（環境変数・秘密情報）

- **環境変数で注入**：モデル ID・リージョン・推論パラメータ・フラグ等。
- UI に露出する `NEXT_PUBLIC_` 変数は **使用しない**。
- 秘密情報はローカル限定で扱い **コミット禁止**。不足時は **起動時に失敗** させる。
- 値の妥当性は zod で検証し、ログに起因箇所を残す（機微値は出力しない）。

---

## 11. ロギング / 観測性

- **構造化ログ**：requestId / user-ish / コンテキストを引き回し、API→Agent→Tool を追跡可能にする。
- **コストと時間**：モデル種別・実行時間・リトライ・（可能なら）トークン使用推定を記録。
- **将来**：OpenTelemetry 等の導入に支障がないよう、コンテキスト引き回しの形を保つ。

---

## 12. レート制限 / Abuse 対策（ローカル最小）

- 固定ウィンドウ or スライディングの簡易レート制限（IP/ユーザー相当識別子）。
- 入力サイズ・メッセージ数・ツール呼出し回数の上限。
- 外部 HTTP / ファイル I/O は **許可リスト** 方式。
- 例外時はユーザー向けエラー＋内部詳細ログを両立。

---

## 13. CI（GitHub Actions）

- **目的**：自動化された品質ゲート（typecheck / lint / test / 依存監査 / 変更差分検出）。
- **実行契機**：PR 作成／更新、main への push。
- **最小ゲート例**：
  - TypeScript strict の型チェック
  - Biome（lint/format チェック）
  - ユニットテスト
  - 依存の脆弱性検査（利用可能な範囲で）
- **成果物**：本ドキュメントでは **具体 YAML は記載しない**。プロジェクト状況に応じて定義・更新し、docs/ に方針を記録する。
- **レビュー連携**：CI 失敗時はマージ不可。CI 成果を PR スレッドに要約（ボット可）。

---

## 14. 将来計画（ページ拡張）

- **Mastra 機能網羅**：
  - 「1 機能 = 1 ページ」を原則に、ツール呼出し・関数呼出し・メモリ・RAG・評価などを段階的に追加。
- **実践カテゴリ**：
  - 「実務的エージェント」向けページを別カテゴリ化し、権限・監査・再実行性・コスト管理も段階導入。
- **拡張性の高い設計**：
  - エージェント定義・ツール・ポリシー・ガード・ロギングを疎結合に保ち、差し替え・増設を容易にする。
  - モデル切替（Bedrock 内外）を阻害しない抽象化を維持。

---

## 15. レビュー / PR チェックリスト

- [ ] **server-only** 原則の順守（キーやツールがクライアントに漏れていない）
- [ ] API 入力は **zod** で検証されている
- [ ] **TypeScript strict** 準拠
- [ ] **ユニットテスト** の追加・更新（TDD の意図が反映）
- [ ] 構造化ログ（requestId / 実行時間 / 失敗理由）あり
- [ ] レート制限・サイズ上限・許可範囲チェックの実装
- [ ] **環境変数** 妥当性チェック（zod）
- [ ] **Biome**（lint/format）パス
- [ ] **Conventional Commits** 準拠
- [ ] **GitHub Issue と PR の紐付け**（参照 or 自動 Close）
- [ ] **docs/** に設計変更・選定理由が記録されている
- [ ] **GitHub Actions**（CI）で typecheck / lint / test がグリーン
- [ ] README.md は人間向けであり、AI 参照禁止を明記

---
